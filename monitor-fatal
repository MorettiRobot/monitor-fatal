from bs4 import BeautifulSoup
from cloudscraper import CloudScraper
import requests
import time
import json
import os

class AlertFatal:
    def __init__(self):
        # DICA: No futuro, use os.environ.get('TELEGRAM_TOKEN') por seguran√ßa
        self.token = '8212331492:AAE3e5-PUAqHk2YZbTWu3Fca44n-O_VcduQ'
        self.id = '5255755160'
        self.site = 'https://fatalmodel.com/acompanhantes-tucurui-pa'
        self.arquivo_db = 'modelos_conhecidas.json'

    def carregar_memoria(self):
        if os.path.exists(self.arquivo_db):
            with open(self.arquivo_db, 'r') as f:
                return json.load(f)
        return []

    def salvar_memoria(self, lista):
        with open(self.arquivo_db, 'w') as f:
            json.dump(lista, f)

    def buscar_dados(self):
        scraper = CloudScraper.create_scraper()
        try:
            req = scraper.get(self.site)
            if req.status_code != 200:
                self.enviar_telegram(f"‚ö†Ô∏è Erro ao acessar site: Status {req.status_code}")
                return None
            
            soup = BeautifulSoup(req.text, 'html.parser')
            cards = soup.find_all('div', class_='shadow-listing-cards')
            
            modelos_atuais = {}
            for card in cards:
                local_div = card.find('div', class_='truncate')
                local = local_div.get_text(strip=True) if local_div else ""
                
                if "Tucuru√≠" in local:
                    nome = card.find('h2').get_text(strip=True) if card.find('h2') else "N/A"
                    preco_div = card.find('div', class_='price-list__value')
                    preco = preco_div.get_text(strip=True) if preco_div else "S/V"
                    link = card.find('a', href=True)['href']
                    if link.startswith('/'): link = "https://fatalmodel.com" + link
                    
                    modelos_atuais[nome] = {"preco": preco, "link": link}
            
            return modelos_atuais
        except Exception as e:
            self.enviar_telegram(f"‚ùå Erro cr√≠tico no scraping: {e}")
            return None

    def enviar_telegram(self, texto):
        url = f"https://api.telegram.org/bot{self.token}/sendMessage"
        payload = {'chat_id': self.id, 'text': texto, 'parse_mode': 'Markdown', 'disable_web_page_preview': True}
        requests.post(url, data=payload)

    def executar(self):
        print(f"[{time.strftime('%H:%M:%S')}] Verificando site...")
        dados_novos = self.buscar_dados()
        if dados_novos is None: return

        nomes_novos = list(dados_novos.keys())
        nomes_antigos = self.carregar_memoria()

        entraram = [n for n in nomes_novos if n not in nomes_antigos]
        sairam = [n for n in nomes_antigos if n not in nomes_novos]

        for nome in entraram:
            m = dados_novos[nome]
            msg = f"‚úÖ **NOVA MODELO EM TUCURU√ç!**\n\nüë§ {nome}\nüí∞ {m['preco']}\nüîó {m['link']}"
            self.enviar_telegram(msg)

        for nome in sairam:
            msg = f"‚ùå **SAIU DO SITE:**\n\nüë§ {nome} n√£o est√° mais na listagem."
            self.enviar_telegram(msg)

        if entraram or sairam:
            self.salvar_memoria(nomes_novos)
        
        # Mensagem de log para voc√™ saber que o bot rodou com sucesso no GitHub
        print("Execu√ß√£o finalizada com sucesso.")

if __name__ == "__main__":
    bot = AlertFatal()
    bot.executar()
